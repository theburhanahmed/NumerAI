# Quick Deployment Guide - DigitalOcean Droplet

This guide walks you through deploying NumerAI to a DigitalOcean droplet using SSH.

## Prerequisites

- DigitalOcean droplet with Docker installed
- SSH access to the droplet
- Domain name configured (optional but recommended)

## Quick Start

### Step 1: Set Up Secrets Locally

Run the interactive secrets setup script to configure all environment variables:

```bash
cd /path/to/NumerAI
./deploy/digitalocean/setup-secrets.sh
```

This will:
- Create `.env.production` file with all required configuration
- Prompt you for all secrets (database passwords, API keys, etc.)
- Generate secure Django SECRET_KEY automatically
- Configure email, CORS, and optional services (Stripe, OpenAI, Firebase, OAuth)

### Step 2: Deploy via SSH

Deploy the application to your droplet:

```bash
# Set environment variables (or export them)
export REMOTE_HOST=your-droplet-ip-or-hostname
export REMOTE_USER=root  # or 'numerai' if you created a dedicated user
export SSH_KEY=/path/to/your/ssh/key  # optional, if using SSH key

# Run deployment
./deploy/digitalocean/ssh-deploy.sh
```

Or set variables inline:

```bash
REMOTE_HOST=your-droplet-ip REMOTE_USER=root ./deploy/digitalocean/ssh-deploy.sh
```

### Step 3: Complete Server Setup (First Time Only)

SSH into your droplet and run the server setup:

```bash
ssh root@your-droplet-ip

# Clone repository if not already cloned
cd /opt
git clone https://github.com/yourusername/NumerAI.git numerai
cd numerai

# Run server setup script
chmod +x deploy/digitalocean/setup-server.sh
sudo ./deploy/digitalocean/setup-server.sh

# Copy your .env.production file (if not already copied by ssh-deploy.sh)
# Or create it manually from the example
cp deploy/digitalocean/env.production.example .env.production
nano .env.production  # Edit with your values
chmod 600 .env.production
```

### Step 4: Configure nginx and SSL

```bash
# On the droplet
cd /opt/numerai

# Configure nginx
sudo cp deploy/digitalocean/nginx/numerai.conf /etc/nginx/sites-available/numerai.conf
sudo nano /etc/nginx/sites-available/numerai.conf  # Update domain name
sudo ln -s /etc/nginx/sites-available/numerai.conf /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx

# Set up SSL certificates
sudo ./deploy/digitalocean/setup-ssl.sh
```

### Step 5: Verify Deployment

```bash
# Check containers
docker ps

# Check logs
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# Test health endpoint
curl https://yourdomain.com/api/v1/health/
```

## Manual Deployment Steps

If you prefer to deploy manually or the automated script fails:

### 1. Copy Files to Server

```bash
# From your local machine
scp -r /path/to/NumerAI root@your-droplet:/opt/numerai
```

### 2. Set Up Environment

```bash
# On the server
cd /opt/numerai
cp deploy/digitalocean/env.production.example .env.production
nano .env.production  # Edit with your values
chmod 600 .env.production
```

### 3. Build and Deploy

```bash
# Build images
docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production build

# Start services
docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production up -d

# Run migrations
docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production exec backend python manage.py migrate

# Collect static files
docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production exec backend python manage.py collectstatic --no-input

# Copy static files to nginx
sudo cp -r backend/staticfiles/* /var/www/numerai/static/
sudo chown -R www-data:www-data /var/www/numerai/static
```

## Updating the Application

After making changes to your code:

```bash
# From local machine
./deploy/digitalocean/ssh-deploy.sh
```

Or manually on the server:

```bash
# SSH into droplet
ssh root@your-droplet-ip
cd /opt/numerai

# Pull latest code
git pull origin main

# Run deployment script
sudo -u numerai ./deploy/digitalocean/deploy.sh
```

## Environment Variables

The `.env.production` file contains all configuration. Key variables:

### Required
- `SECRET_KEY` - Django secret key (auto-generated by setup script)
- `ALLOWED_HOSTS` - Your domain names
- `DB_PASSWORD` - Strong database password
- `EMAIL_*` - Email configuration

### Important
- `CORS_ALLOWED_ORIGINS` - Frontend URLs
- `NEXT_PUBLIC_API_URL` - Frontend API endpoint

### Optional
- `STRIPE_*` - Payment processing
- `OPENAI_API_KEY` - AI features
- `FIREBASE_CREDENTIALS` - Push notifications
- OAuth credentials for social login

## Troubleshooting

### Connection Issues

```bash
# Test SSH connection
ssh root@your-droplet-ip

# Check firewall
sudo ufw status

# Check Docker
docker ps
```

### Service Issues

```bash
# View logs
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs frontend

# Restart services
docker-compose -f docker-compose.yml -f docker-compose.prod.yml restart

# Check container status
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

### Database Issues

```bash
# Check database connection
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec backend python manage.py dbshell

# Run migrations manually
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec backend python manage.py migrate
```

### nginx Issues

```bash
# Test configuration
sudo nginx -t

# Check error logs
sudo tail -f /var/log/nginx/numerai-error.log

# Reload nginx
sudo systemctl reload nginx
```

## Security Checklist

- [ ] `.env.production` has permissions 600 (owner read/write only)
- [ ] Strong passwords for database and all services
- [ ] SSL certificates configured and auto-renewal enabled
- [ ] Firewall configured (UFW) - only ports 22, 80, 443 open
- [ ] SSH key authentication enabled (disable password auth)
- [ ] Regular backups configured
- [ ] System updates installed
- [ ] Fail2ban configured

## Next Steps

1. Set up automated backups
2. Configure monitoring (e.g., UptimeRobot)
3. Set up log rotation
4. Configure fail2ban for additional security
5. Set up CI/CD pipeline for automatic deployments

For detailed information, see the full [DigitalOcean Deployment Guide](../../docs/DIGITALOCEAN_DEPLOYMENT.md).

